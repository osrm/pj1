name: Cat-Data Lab Data Collection (3-Track Strategy)

on:
  workflow_dispatch:
    inputs:
      max_results:
        description: '브랜드당/가격대별 최대 결과 수'
        required: false
        default: '100'
        type: choice
        options:
          - '50'
          - '100'
          - '200'
          - '500'

env:
  NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
  NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
  PJ1_DB_REPO: osrm/pj1_DB

jobs:
  collect-data:
    runs-on: ubuntu-latest

    steps:
      # 1. pj1_DB private repo 체크아웃 (코드 + DB)
      - name: Checkout pj1_DB private repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PJ1_DB_REPO }}
          token: ${{ secrets.TOKEN1 }}

      # 2. Python 설정
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 3. 의존성 설치
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. 네이버 API 테스트
      - name: Test Naver API
        run: PYTHONPATH=. python scripts/test_naver_api.py
        env:
          NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}

      # 5. 3-Track 데이터 수집
      - name: Run 3-Track data collection
        run: |
          PYTHONPATH=. python scripts/run_all_sqlite.py ${{ github.event.inputs.max_results || '100' }}
        env:
          NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}

      # 6. brands.json 및 DB 업데이트 확인
      - name: Check for updates
        run: |
          echo "=== brands.json 상태 ==="
          cat brands.json | head -20
          echo ""
          echo "=== DB 파일 크기 ==="
          ls -lh cat_data.db

      # 7. 변경사항 커밋 (브랜드 사전 업데이트)
      - name: Commit brands.json updates
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git diff --quiet brands.json || git add brands.json && git commit -m "Update brands.json [skip ci]" || echo "No changes to brands.json"

      # 8. DB 파일을 Artifact로 저장
      - name: Upload DB artifact
        uses: actions/upload-artifact@v4
        with:
          name: cat-data-db-${{ github.run_number }}
          path: cat_data.db
          retention-days: 30

      # 9. 데이터 요약
      - name: Show data summary
        run: |
          echo "=== 데이터베이스 요약 ==="
          sqlite3 cat_data.db "SELECT COUNT(*) as total_foods FROM foods;"
          sqlite3 cat_data.db "SELECT COUNT(*) as total_brands FROM brands;"
          echo ""
          echo "=== 상위 5개 사료 ==="
          sqlite3 cat_data.db "SELECT f.name, b.name as brand, f.min_price FROM foods f LEFT JOIN brands b ON f.brand_id = b.id LIMIT 5;"

      # 10. DB를 pj1_DB에 푸시
      - name: Push to pj1_DB
        run: git push origin main

      # 11. DB 파일을 Google Cloud Storage에 업로드 (선택)
      - name: Upload to GCS (optional)
        if: false
        uses: 'google-github-actions/upload-cloud-storage@v2'
        with:
          path: 'cat_data.db'
          destination: 'cat-data-lab/db/'
          credentials_json: ${{ secrets.GCS_CREDENTIALS }}
