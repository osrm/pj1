"""
데이터 수집 전략 및 범위 정의 (네이버 API 전용)

## 1. 전체 데이터 수집 범위

### 네이버 쇼핑 고양이 사료 검색
- 검색어: "고양이 사료", "캣 푸드", "cat food"
- API 제한: 검색당 최대 1,000개
- 여러 검색어로 데이터 확장

---

## 2. 검색어 전략

### 기본 검색어 (최대 커버리지)
1. 고양이 사료 (최대 1,000개)
2. 캣 푸드 (추가)
3. cat food (추가)

### 세부 검색어 (프리미엄/특수 사료)
4. 프리미엄 고양이 사료
5. 곡물 무함유 고양이 사료
6. 저자극 고양이 사료
7. 다이어트 고양이 사료
8. 키튼 고양이 사료
9. 시니어 고양이 사료

---

## 3. 중복 제거 전략

### 중복 기준
1. **naver_product_id**: 네이버 상품 고유 ID (최우선)
2. **name + brand**: 사료명 + 브랜드명 (보조)
3. **link**: 상품 링크 URL (보조)

### 중복 발생 케이스
- 동일 사료의 다양한 사이즈 (1.5kg, 5.4kg, 10kg)
- 동일 사료의 다양한 판매처 (쇼핑몰별)
- 동일 사료의 다른 검색어 결과

### 중복 제거 로직
```python
# 1차: naver_product_id 기반
existing = session.query(Food).filter_by(
    naver_product_id=product_id
).first()

# 2차: name + brand 기반 (ID가 없는 경우)
if not existing:
    existing = session.query(Food).filter(
        Food.name == normalized_name,
        Food.brand_id == brand_id
    ).first()
```

---

## 4. API 수집 전략

### 네이버 쇼핑 검색 API
- API 호출: `https://openapi.naver.com/v1/search/shop.json`
- 파라미터:
  - query: 검색어
  - display: 결과 수 (최대 100)
  - start: 시작 위치 (최대 1000)
  - sort: 정렬 (sim: 정확도, date: 날짜)

### 수집 속도 계산
- 검색어당: 최대 1,000개
- 딜레이: 0.1초/요청 (API 제한 준수)
- 예상 시간: 10~20초/검색어

---

## 5. 단계별 수집 계획

### Phase 1: 기본 검색어 (최대 3,000개)
- 고양이 사료, 캣 푸드, cat food
- 목적: 빠른 DB 구축 및 테스트

### Phase 2: 세부 검색어 (추가 수천개)
- 프리미엄/특수 사료 검색어로 추가 수집
- 곡물 무함유, 저자극, 다이어트 등

---

## 6. 수집 항목

### 필수 항목
1. naver_product_id (중복 제거용)
2. name (사료명)
3. brand (브랜드)
4. category (건식/습식)
5. price (가격)
6. link (상품 링크)
7. image (상품 이미지)

### 선택 항목
8. mall_name (판매처)
9. review_count (리뷰 수)
10. rating (평점)
11. manufacturer (제조사)

---

## 7. GitHub Actions 실행 시나리오

### 시나리오 1: 기본 검색어 (빠른 테스트)
```bash
python scripts/run_all_sqlite.py 100
```

### 시나리오 2: 전체 검색어 (최대 수집)
```bash
python scripts/run_all_sqlite.py 1000
```

---

## 8. 중복 제거 예시

### 중복 케이스 1: 동일 사료 다른 사이즈
```
[1] 오리젠 고양이 성묘 사료 5.4kg
[2] 오리젠 고양이 성묘 사료 1.5kg
[3] 오리젠 고양이 성묘 사료 10kg

→ 모두 다른 상품 (사이즈 다름)
→ 전부 저장
```

### 중복 케이스 2: 동일 사료 동일 사이즈 다른 판매처
```
[1] 오리젠 고양이 성묘 사료 5.4kg (쇼핑몰 A)
[2] 오리젠 고양이 성묘 사료 5.4kg (쇼핑몰 B)
[3] 오리젠 고양이 성묘 사료 5.4kg (쇼핑몰 C)

→ naver_product_id가 다름
→ 사이즈 동일, 이름+브랜드 동일
→ 하나만 저장 (중복 제거)
```

---

## 9. API 호출 전략

### 장점
- 빠른 데이터 수집
- 안정적이고 신뢰성 높음
- 웹사이트 구조 변화 영향 없음

### 단점
- 검색당 최대 1,000개 제한
- 네이버 계정 및 API 키 필요

---

## 10. 추천 수집 순서

1. **Phase 1**: 기본 검색어 → 빠른 DB 구축
2. **테스트**: 중복 제거, 스키마 검증
3. **Phase 2**: 세부 검색어 → 추가 데이터 수집

---

## 11. 에러 핸들링

### API 호출 에러
- 로깅
- 재시도 로직
- 실패 시 계속 진행 (전체 실패 방지)

### API 제한 초과
- 딜레이 증가
- 요청 속도 조절
